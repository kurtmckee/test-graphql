name: "Create a release branch"
on:
  workflow_dispatch:
    inputs:
      version:
        description: "The version of the package to release."
        required: true
        type: string

jobs:
  hard-coded:
    name: "Hard-coded"
    runs-on: "ubuntu-latest"
    permissions:
      contents: "write"
      pull-requests: "write"
    env:
      GH_TOKEN: "${{ github.token }}"
    steps:
      - name: "Create a new branch"
        run: |
          echo "The current SHA is $GITHUB_SHA"

          gh api "/repos/$GITHUB_REPOSITORY/git/refs" \
            --method POST \
            --header "Accept: application/vnd.github+json" \
            --header "X-GitHub-Api-Version: 2022-11-28" \
            --raw-field "ref=refs/heads/release/${{ inputs.version }}" \
            --raw-field "sha=$GITHUB_SHA"

      - name: "Checkout the current repo"
        uses: "actions/checkout@v4"

      - name: "Create a new commit (hard-coded)"
        run: |
          echo '{
            "query": "mutation ($input:CreateCommitOnBranchInput!) { createCommitOnBranch(input: $input) { commit { oid } }}",
            "variables": {
              "input": {
                "branch": {
                  "branchName": "release/${{ inputs.version }}",
                  "repositoryNameWithOwner": "kurtmckee/test-graphql"
                },
                "expectedHeadOid": "${{ github.sha }}",
                "fileChanges": {
                  "additions": [
                    {
                      "contents": "",
                      "path": "v${{ inputs.version }}"
                    }
                  ]
                },
                "message": {
                  "headline": "Test creating a commit"
                }
              }
            }
          }' > query-body.json
          
          gh api graphql --input query-body.json

      - name: "Open a PR"
        run: |
          gh pr create \
            --head "release/${{ inputs.version }}" \
            --base main \
            --title "Release ${{ inputs.version }}" \
            --body "Please pull these awesome changes in!" \

#          gh api "/repos/$GITHUB_REPOSITORY/git/refs" \
#            --method POST \
#            --header "Accept: application/vnd.github+json" \
#            --header "X-GitHub-Api-Version: 2022-11-28" \
#            --raw-field "ref=refs/heads/release/${{ inputs.version }}" \
#            --raw-field "sha=$GITHUB_SHA"

#          gh api /repos/$GITHUB_REPOSITORY/pulls \
#            --method POST \
#            --header "Accept: application/vnd.github+json" \
#            --header "X-GitHub-Api-Version: 2022-11-28" \
#            --raw-field "title=Release ${{ inputs.version }}" \
#            --raw-field "body=Please pull these awesome changes in!" \
#            --raw-field "head=release/${{ inputs.version }}"
#            --raw-field "base=main"

